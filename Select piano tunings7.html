<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dual Multi-Tuning Pianos (Pianish/Synth Waves)</title>
    <style>
        /* CSS from previous version */
        body{display:flex;flex-direction:column;align-items:center;min-height:100vh;background-color:#2c3e50;margin:0;padding:20px 0;font-family:sans-serif;overflow-y:auto;overflow-x:hidden;-webkit-tap-highlight-color:transparent}.keyboard-section{width:100%;display:flex;flex-direction:column;align-items:center;margin-bottom:30px}.header-controls{display:flex;flex-direction:column;align-items:center;margin-bottom:15px;color:#ecf0f1;width:90%;max-width:1000px}.header-controls h2{margin-top:0;margin-bottom:10px;font-size:1.5em}.controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px;width:100%;align-items:center}.control-group{display:flex;align-items:center;justify-content:center;padding:5px;flex-wrap:nowrap}.octave-controls button{padding:7px 10px;margin:0 4px;background-color:#3498db;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:.85em}.octave-controls button:hover{background-color:#2980b9}.control-group span{font-size:.85em;margin:0 5px;white-space:nowrap}.slider-input{width:80px;margin-left:4px}.control-select{padding:6px 8px;border-radius:4px;border:1px solid #7f8c8d;background-color:#ecf0f1;color:#2c3e50;font-size:.85em;margin-left:4px;min-width:140px}.piano-container{display:flex;justify-content:flex-start;width:95%;max-width:100%;padding:10px;background-color:#34495e;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.2);overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch}.piano{display:flex;position:relative;width:fit-content;height:180px}.key{border:1px solid #1c2833;box-sizing:border-box;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none;transition:background-color .05s ease,transform .05s ease;display:flex;flex-direction:column;justify-content:space-around;align-items:center;padding:5px 2px;text-align:center;margin-right:1px;width:30px;min-width:18px;flex-shrink:0}.key.is-white{background-color:#f8f9fa;color:#212529}.key.is-black{background-color:#343a40;color:#f8f9fa;border-color:#212529}.key:last-child{margin-right:0}.key-step-label{font-size:.8em;font-weight:700;display:block}.key-interval-label{font-size:.55em;line-height:1;display:block;margin:1px 0}.key-division-info{font-size:.5em;line-height:1;display:block}.key.active,.key:active{filter:brightness(.85)}.key.is-white.active,.key.is-white:active{background-color:#ced4da;color:#000}.key.is-black.active,.key.is-black:active{background-color:#5a6268;color:#fff}.key.active{transform:scaleY(.97) translateY(2px);box-shadow:inset 0 0 4px rgba(0,0,0,.2)}
    </style>
</head>
<body>

    <div class="keyboard-section">
        <div class="header-controls">
            <h2>Piano 1 (<span class="tuning-display" id="tuning-display-1">12-EDO</span>)</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <span>Tuning:</span>
                    <select class="control-select tuning-select" id="tuning-select-1">
                        <option value="5">5-EDO</option>
                        <option value="7">7-EDO</option>
                        <option value="9">9-EDO</option>
                        <option value="12" selected>12-EDO</option>
                        <option value="15">15-EDO</option>
                        <option value="17">17-EDO</option>
                        <option value="19">19-EDO</option>
                        <option value="22">22-EDO</option>
                        <option value="24">24-EDO (Quarter)</option>
                        <option value="31">31-EDO</option>
                        <option value="41">41-EDO</option>
                        <option value="53">53-EDO</option>
                        <option value="ji_5_limit_chromatic">5-Limit JI (12n)</option>
                        <option value="ji_7_limit_chromatic">7-Limit JI (14n)</option>
                        <option value="ji_11_limit_example">11-Limit JI (11n Ex.)</option>
                        <option value="ji_13_limit_example">13-Limit JI (10n Ex.)</option>
                        <option value="ji_pythagorean_chromatic">Pythagorean (12n)</option>
                        <option value="tm_meantone_qc">Meantone (¬ºc)</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="octave-down-1">Oct-</button>
                    <span>Oct: <span id="current-octave-1">0</span></span>
                    <button id="octave-up-1">Oct+</button>
                </div>
                <div class="control-group">
                    <span>Zoom:</span>
                    <input type="range" class="slider-input" id="zoom-slider-1" min="18" max="120" value="40">
                </div>
                <div class="control-group">
                    <span>Vol:</span>
                    <input type="range" class="slider-input" id="volume-slider-1" min="0" max="1" step="0.01" value="0.5">
                </div>
                <div class="control-group">
                    <span>Wave:</span>
                    <select class="control-select wave-select" id="wave-type-1">
                        <option value="sine" selected>Sine</option>
                        <option value="square">Square</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="triangle">Triangle</option>
                        <option value="organ">Organ</option>
                        <option value="bright_pluck">Bright Pluck</option>
                        <option value="pianish">Pianish</option>
                        <option value="synth_saw">Synth Saw</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="piano-container">
            <div class="piano" id="piano-keys-1"></div>
        </div>
    </div>

    <hr style="width:80%; margin: 20px auto; border-color: #4a6fa5;">

    <div class="keyboard-section">
        <div class="header-controls">
            <h2>Piano 2 (<span class="tuning-display" id="tuning-display-2">12-EDO</span>)</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <span>Tuning:</span>
                    <select class="control-select tuning-select" id="tuning-select-2">
                        <option value="5">5-EDO</option>
                        <option value="7">7-EDO</option>
                        <option value="9">9-EDO</option>
                        <option value="12" selected>12-EDO</option>
                        <option value="15">15-EDO</option>
                        <option value="17">17-EDO</option>
                        <option value="19">19-EDO</option>
                        <option value="22">22-EDO</option>
                        <option value="24">24-EDO (Quarter)</option>
                        <option value="31">31-EDO</option>
                        <option value="41">41-EDO</option>
                        <option value="53">53-EDO</option>
                        <option value="ji_5_limit_chromatic">5-Limit JI (12n)</option>
                        <option value="ji_7_limit_chromatic">7-Limit JI (14n)</option>
                        <option value="ji_11_limit_example">11-Limit JI (11n Ex.)</option>
                        <option value="ji_13_limit_example">13-Limit JI (10n Ex.)</option>
                        <option value="ji_pythagorean_chromatic">Pythagorean (12n)</option>
                        <option value="tm_meantone_qc">Meantone (¬ºc)</option>
                    </select>
                </div>
                 <div class="control-group">
                    <button id="octave-down-2">Oct-</button>
                    <span>Oct: <span id="current-octave-2">0</span></span>
                    <button id="octave-up-2">Oct+</button>
                </div>
                <div class="control-group">
                    <span>Zoom:</span>
                    <input type="range" class="slider-input" id="zoom-slider-2" min="18" max="120" value="40">
                </div>
                <div class="control-group">
                    <span>Vol:</span>
                    <input type="range" class="slider-input" id="volume-slider-2" min="0" max="1" step="0.01" value="0.5">
                </div>
                 <div class="control-group">
                    <span>Wave:</span>
                    <select class="control-select wave-select" id="wave-type-2">
                        <option value="sine" selected>Sine</option>
                        <option value="square">Square</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="triangle">Triangle</option>
                        <option value="organ">Organ</option>
                        <option value="bright_pluck">Bright Pluck</option>
                        <option value="pianish">Pianish</option>
                        <option value="synth_saw">Synth Saw</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="piano-container">
            <div class="piano" id="piano-keys-2"></div>
        </div>
    </div>

    <script>
        const BASE_C4_FREQ = 261.63;

        const allTuningsData = {
            "5": { name: "5-EDO", type: "edo", edo_divisions: 5, labels: [], whiteKeySteps: [0,1,2,3,4]},
            "7": { name: "7-EDO", type: "edo", edo_divisions: 7, labels: [], whiteKeySteps: [0,1,2,3,4,5,6] },
            "9": { name: "9-EDO", type: "edo", edo_divisions: 9, labels: [], whiteKeySteps: [0,2,3,5,7,8]},
            "12": { name: "12-EDO", type: "edo", edo_divisions: 12, labels: ["C","C‚ôØ","D","D‚ôØ","E","F","F‚ôØ","G","G‚ôØ","A","A‚ôØ","B"], whiteKeySteps: [0,2,4,5,7,9,11] },
            "15": { name: "15-EDO", type: "edo", edo_divisions: 15, labels: [], whiteKeySteps: [0,2,4,5,7,9,11,12,14] },
            "17": { name: "17-EDO", type: "edo", edo_divisions: 17, labels: [], whiteKeySteps: [0,2,3,5,7,8,10,12,13,15] },
            "19": { name: "19-EDO", type: "edo", edo_divisions: 19, labels: ["C","C‚ôØ","Db","D","D‚ôØ","Eb","E","F‚ô≠","F","F‚ôØ","Gb","G","G‚ôØ","Ab","A","A‚ôØ","Bb","B","Cb"], whiteKeySteps: [0,2,3,5,6,8,10,11,13,14,16,17] },
            "22": { name: "22-EDO", type: "edo", edo_divisions: 22, labels: [], whiteKeySteps: [0,3,4,7,11,14,15,18] },
            "24": { name: "24-EDO (Quarter)", type: "edo", edo_divisions: 24, labels: ["C","C¬º‚ôØ","C‚ôØ","D¬º‚ô≠","D","D¬º‚ôØ","D‚ôØ","E¬º‚ô≠","E","E¬º‚ôØ","F","F¬º‚ôØ","F‚ôØ","G¬º‚ô≠","G","G¬º‚ôØ","G‚ôØ","A¬º‚ô≠","A","A¬º‚ôØ","A‚ôØ","B¬º‚ô≠","B","B¬º‚ôØ"], whiteKeySteps: [0,4,8,10,14,18,22] },
            "31": { name: "31-EDO", type: "edo", edo_divisions: 31, labels: ["C","DùÑ´","C‚ôØ","D‚ô≠","CùÑ™","D","EùÑ´","D‚ôØ","E‚ô≠","DùÑ™","E","F‚ô≠","E‚ôØ","F","GùÑ´","F‚ôØ","G‚ô≠","FùÑ™","G","AùÑ´","G‚ôØ","A‚ô≠","GùÑ™","A","BùÑ´","A‚ôØ","B‚ô≠","AùÑ™","B","C‚ô≠","B‚ôØ"], whiteKeySteps: [0,5,10,13,18,23,28] },
            "41": { name: "41-EDO", type: "edo", edo_divisions: 41, labels: [], whiteKeySteps: [0,7,14,17,24,31,38] },
            "53": { name: "53-EDO", type: "edo", edo_divisions: 53, labels: [], whiteKeySteps: [0,9,18,22,31,40,49] },
            "ji_5_limit_chromatic": { name: "5-Limit JI (12n)", type: "ratios", values: [1/1,16/15,9/8,6/5,5/4,4/3,45/32,3/2,8/5,5/3,9/5,15/8], ratioStrings: ["1/1","16/15","9/8","6/5","5/4","4/3","45/32","3/2","8/5","5/3","9/5","15/8"], labels: ["C","D‚ô≠","D","E‚ô≠","E","F","F‚ôØ","G","A‚ô≠","A","B‚ô≠","B"], whiteKeySteps: [0,2,4,5,7,9,11]},
            "ji_pythagorean_chromatic": { name: "Pythagorean (12n)", type: "ratios", values: [1/1,256/243,9/8,32/27,81/64,4/3,729/512,3/2,128/81,27/16,16/9,243/128], ratioStrings: ["1/1","256/243","9/8","32/27","81/64","4/3","729/512","3/2","128/81","27/16","16/9","243/128"], labels: ["C","D‚ô≠‚Çö","D","E‚ô≠‚Çö","E‚Çö","F","F‚ôØ‚Çö","G","A‚ô≠‚Çö","A‚Çö","B‚ô≠‚Çö","B‚Çö"], whiteKeySteps: [0,2,4,5,7,9,11]},
            "ji_7_limit_chromatic": { name: "7-Limit JI (14n)", type: "ratios", values: [1/1,21/20,9/8,8/7,7/6,5/4,9/7,21/16,7/5,10/7,3/2,27/16,12/7,7/4], ratioStrings: ["1/1","21/20","9/8","8/7","7/6","5/4","9/7","21/16","7/5","10/7","3/2","27/16","12/7","7/4"], labels: ["Do","C‚Çá‚ôØ","Re","Re‚ô≠‚Çá","Mi‚ô≠‚Çá","Mi","Fa‚ô≠‚Çá","Fa‚Çá","Fa‚ôØ‚Çá","Sol‚ô≠‚Çá","Sol","La‚Çö","La‚ôØ‚Çö","Ti‚ô≠‚Çá"], whiteKeySteps: [0,2,5,7,10,11,13]},
            "ji_11_limit_example": { name: "11-Limit JI (11n Ex.)", type: "ratios", values: [1/1,9/8,11/9,5/4,14/11,4/3,11/8,16/11,3/2,5/3,11/6], ratioStrings: ["1/1","9/8","11/9","5/4","14/11","4/3","11/8","16/11","3/2","5/3","11/6"], labels: ["Do","Re","Me‚ÇÅ‚ÇÅ","Mi","Fa'‚ÇÅ‚ÇÅ","Fa","Fi‚ÇÅ‚ÇÅ","Sol‚ô≠‚ÇÅ‚ÇÅ","Sol","La","Li‚ÇÅ‚ÇÅ"], whiteKeySteps: [0,1,3,5,8,9]},
            "ji_13_limit_example": { name: "13-Limit JI (10n Ex.)", type: "ratios", values: [1/1,9/8,16/13,5/4,13/10,4/3,3/2,13/8,5/3,15/8], ratioStrings: ["1/1","9/8","16/13","5/4","13/10","4/3","3/2","13/8","5/3","15/8"], labels: ["Do","Re","m3‚ÇÅ‚ÇÉ","Mi","M3‚ÇÅ‚ÇÉ","Fa","Sol","M6‚ÇÅ‚ÇÉ","La","Ti"], whiteKeySteps: [0,1,3,5,6,8,9]},
            "tm_meantone_qc": { name: "Meantone (¬ºc)", type: "cents", values: [0,76,193.2,310.3,386.3,503.4,579.5,696.6,813.7,889.7,1006.8,1082.9], ratioStrings: ["1/1","~25/24","~‚àö(5)/2","~6/5","5/4","~4*‚àö(1/5)","~‚àö2","5^(1/4)","~8/5","~5^(3/4)/2","~16/9","~15/8"], labels: ["C","C‚ôØ","D","E‚ô≠","E","F","F‚ôØ","G","G‚ôØ","A","B‚ô≠","B"], whiteKeySteps: [0,2,4,5,7,9,11]}
        };

        for (const key in allTuningsData) { /* ... auto-fill EDO labels ... */ }
        for (const key in allTuningsData) {
            const tuning = allTuningsData[key];
            if (tuning.type === "edo" && tuning.labels.length === 0) {
                for (let i = 0; i < tuning.edo_divisions; i++) {
                    tuning.labels.push(`S${i}`);
                }
            } else if (tuning.type === "edo" && tuning.labels.length !== tuning.edo_divisions) {
                const currentLabels = tuning.labels;
                const divisions = tuning.edo_divisions;
                if (currentLabels.length < divisions) {
                    for (let i = currentLabels.length; i < divisions; i++) {
                        currentLabels.push(`S${i}`);
                    }
                }
                tuning.labels = currentLabels.slice(0, divisions);
            }
            if (tuning.type === "ratios" && (!tuning.ratioStrings || tuning.ratioStrings.length !== tuning.values.length)) {
                tuning.ratioStrings = tuning.values.map(v => `~${v.toFixed(3)}`);
            }
            if (tuning.type === "cents" && (!tuning.ratioStrings || tuning.ratioStrings.length !== tuning.values.length)) {
                 tuning.ratioStrings = tuning.values.map(() => ``);
            }
        }

        let audioContext;
        const pianoInstances = [];
        let customWaves = {};

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (Object.keys(customWaves).length === 0) {
                    let organReal = new Float32Array([0, 0.8, 0.5, 0.6, 0.3]);
                    let organImag = new Float32Array(organReal.length).fill(0);
                    customWaves.organ = audioContext.createPeriodicWave(organReal, organImag, {disableNormalization: false});

                    let pluckReal = new Float32Array([0, 0.7, 0.4, 0.2, 0.3, 0.1, 0.15, 0.05, 0.1]);
                    let pluckImag = new Float32Array(pluckReal.length).fill(0);
                    customWaves.bright_pluck = audioContext.createPeriodicWave(pluckReal, pluckImag, {disableNormalization: false});

                    // "Pianish" sound: Many harmonics, amplitudes generally decreasing.
                    // More complex decay would require changing the wave over time or filtering.
                    const pianishHarmonics = 10;
                    let pianishReal = new Float32Array(pianishHarmonics + 1); // +1 for DC offset
                    let pianishImag = new Float32Array(pianishHarmonics + 1);
                    pianishReal[0] = 0; pianishImag[0] = 0; // DC offset
                    for (let i = 1; i <= pianishHarmonics; i++) {
                        pianishReal[i] = (Math.random() * 0.5 + 0.5) / (i * 1.2); // Randomize amplitude slightly, decreasing
                        pianishImag[i] = (Math.random() * 0.2 - 0.1) / i;      // Slight phase randomness
                    }
                    customWaves.pianish = audioContext.createPeriodicWave(pianishReal, pianishImag, {disableNormalization: true}); // Normalization might make it too consistent


                    // "Synth Saw" (Custom Sawtooth using PeriodicWave for potential fine-tuning)
                    // A perfect sawtooth has imag (sine) components: b_n = (2A/œÄ) * ((-1)^(n+1))/n
                    // For simplicity, we'll use a common approximation with many harmonics.
                    const synthSawHarmonics = 16; // More harmonics for a brighter saw
                    let synthSawReal = new Float32Array(synthSawHarmonics + 1).fill(0);
                    let synthSawImag = new Float32Array(synthSawHarmonics + 1);
                    synthSawImag[0] = 0;
                    for (let i = 1; i <= synthSawHarmonics; i++) {
                        synthSawImag[i] = 1 / i; // Amplitude proportional to 1/n
                    }
                    customWaves.synth_saw = audioContext.createPeriodicWave(synthSawReal, synthSawImag, {disableNormalization: false});
                }
            }
        }

        function createPianoInstance(config) {
            const pianoElement = document.getElementById(config.pianoId);
            const tuningDisplayElement = document.getElementById(config.tuningDisplayId);
            const tuningSelectElement = document.getElementById(config.tuningSelectId);
            const octaveDisplayElement = document.getElementById(config.octaveDisplayId);
            const octaveUpButtonElement = document.getElementById(config.octaveUpId);
            const octaveDownButtonElement = document.getElementById(config.octaveDownId);
            const zoomSliderElement = document.getElementById(config.zoomSliderId);
            const volumeSliderElement = document.getElementById(config.volumeSliderId);
            const waveTypeSelectElement = document.getElementById(config.waveTypeId);

            let currentTuningSystem = tuningSelectElement.value;
            let currentOctaveOffset = config.initialOctave;
            let currentVolume = parseFloat(volumeSliderElement.value);
            let currentWaveType = waveTypeSelectElement.value;
            const activeOscillators = {};

            const masterGainNode = audioContext ? audioContext.createGain() : null;
            if (masterGainNode) {
                masterGainNode.gain.setValueAtTime(currentVolume, audioContext.currentTime);
                masterGainNode.connect(audioContext.destination);
            }

            // --- Helper Functions ---
            function getCurrentTuningObject() { return allTuningsData[currentTuningSystem] || allTuningsData["12"]; }
            function updateTuningDisplayTitle() { tuningDisplayElement.textContent = getCurrentTuningObject().name; }
            function updateOctaveDisplay() { octaveDisplayElement.textContent = currentOctaveOffset; }
            function applyZoom() {
                const keyWidth = zoomSliderElement.value + 'px';
                pianoElement.querySelectorAll('.key').forEach(key => key.style.width = keyWidth);
            }
            function updateVolume() {
                currentVolume = parseFloat(volumeSliderElement.value);
                if (masterGainNode && audioContext) {
                    masterGainNode.gain.setValueAtTime(currentVolume, audioContext.currentTime);
                }
            }
            function updateWaveType() { currentWaveType = waveTypeSelectElement.value; }
            // --- End of Helper Functions ---


            function updateTuningSystem() {
                stopAllNotesForThisInstance();
                currentTuningSystem = tuningSelectElement.value;
                updateTuningDisplayTitle();
                generateKeys();
            }

            function generateKeys() { /* ... same ... */ }
            function generateKeys() {
                pianoElement.innerHTML = '';
                pianoElement.querySelectorAll('.key.active').forEach(k => k.classList.remove('active'));

                const tuningObject = getCurrentTuningObject();
                const numKeys = tuningObject.labels.length;
                const currentIntervalLabels = tuningObject.labels;
                const whiteKeySteps = tuningObject.whiteKeySteps || null;

                for (let i = 0; i < numKeys; i++) {
                    const key = document.createElement('div');
                    key.classList.add('key');
                    key.dataset.step = i;

                    if (whiteKeySteps && whiteKeySteps.length > 0) {
                        if (whiteKeySteps.includes(i)) { key.classList.add('is-white'); }
                        else { key.classList.add('is-black'); }
                    } else { 
                        key.classList.add('is-white'); 
                    }


                    const stepLabel = document.createElement('span');
                    stepLabel.classList.add('key-step-label');
                    stepLabel.textContent = i;

                    const intervalLabel = document.createElement('span');
                    intervalLabel.classList.add('key-interval-label');
                    intervalLabel.textContent = currentIntervalLabels[i] || `S${i}`;

                    const divisionInfoLabel = document.createElement('span');
                    divisionInfoLabel.classList.add('key-division-info');
                    let divisionText = "";

                    if (tuningObject.type === "edo") {
                        const cents = (i * 1200) / tuningObject.edo_divisions;
                        divisionText = `${cents.toFixed(1)}¬¢`;
                    } else if (tuningObject.type === "ratios") {
                        const ratioStr = tuningObject.ratioStrings ? tuningObject.ratioStrings[i] : "N/A";
                        const cents = 1200 * Math.log2(tuningObject.values[i]);
                        divisionText = `${ratioStr} (${cents.toFixed(1)}¬¢)`;
                    } else if (tuningObject.type === "cents") {
                        const ratioStr = tuningObject.ratioStrings ? tuningObject.ratioStrings[i] : "";
                        const cents = tuningObject.values[i];
                        divisionText = ratioStr ? `${ratioStr} (${cents.toFixed(1)}¬¢)` : `${cents.toFixed(1)}¬¢`;
                    }
                    divisionInfoLabel.textContent = divisionText;

                    key.appendChild(stepLabel);
                    key.appendChild(intervalLabel);
                    key.appendChild(divisionInfoLabel);
                    pianoElement.appendChild(key);
                    addKeyListeners(key);
                }
                applyZoom();
            }


            function calculateFrequency(step) { /* ... same ... */ }
            function calculateFrequency(step) {
                let frequency;
                const tuningObject = getCurrentTuningObject();

                if (tuningObject.type === "ratios") {
                    if (tuningObject.values && tuningObject.values[step] !== undefined) {
                        frequency = BASE_C4_FREQ * tuningObject.values[step] * Math.pow(2, currentOctaveOffset);
                    } else { frequency = BASE_C4_FREQ * Math.pow(2, currentOctaveOffset); }
                } else if (tuningObject.type === "cents") {
                     if (tuningObject.values && tuningObject.values[step] !== undefined) {
                        const ratioFromCents = Math.pow(2, tuningObject.values[step] / 1200);
                        frequency = BASE_C4_FREQ * ratioFromCents * Math.pow(2, currentOctaveOffset);
                    } else { frequency = BASE_C4_FREQ * Math.pow(2, currentOctaveOffset); }
                } else if (tuningObject.type === "edo") {
                    const edo = tuningObject.edo_divisions;
                    if (edo > 0 && step < edo) {
                        const totalSteps = (currentOctaveOffset * edo) + step;
                        frequency = BASE_C4_FREQ * Math.pow(2, totalSteps / edo);
                    } else { frequency = BASE_C4_FREQ * Math.pow(2, currentOctaveOffset); }
                } else { frequency = BASE_C4_FREQ * Math.pow(2, currentOctaveOffset); }
                return frequency;
            }


            function playNote(step) {
                initAudioContext();
                if (!audioContext || !masterGainNode) return;
                const frequency = calculateFrequency(step);
                if (isNaN(frequency)) {
                    console.error("Calculated frequency is NaN for step:", step, "tuning:", currentTuningSystem);
                    return;
                }
                const uniqueId = `${config.pianoId}-${currentTuningSystem}-${step}-${currentOctaveOffset}`;

                if (activeOscillators[uniqueId]) { /* ... retrigger ... */ }
                if (activeOscillators[uniqueId]) {
                    const oldOsc = activeOscillators[uniqueId];
                    oldOsc.individualGainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    oldOsc.individualGainNode.gain.setValueAtTime(oldOsc.individualGainNode.gain.value, audioContext.currentTime);
                    oldOsc.individualGainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.01);
                    oldOsc.oscillator.stop(audioContext.currentTime + 0.01);
                    delete activeOscillators[uniqueId];
                }


                const oscillator = audioContext.createOscillator();
                const individualGainNode = audioContext.createGain();

                // Set waveform
                if (currentWaveType === "organ" && customWaves.organ) {
                    oscillator.setPeriodicWave(customWaves.organ);
                } else if (currentWaveType === "bright_pluck" && customWaves.bright_pluck) {
                    oscillator.setPeriodicWave(customWaves.bright_pluck);
                } else if (currentWaveType === "pianish" && customWaves.pianish) {
                    oscillator.setPeriodicWave(customWaves.pianish);
                } else if (currentWaveType === "synth_saw" && customWaves.synth_saw) {
                    oscillator.setPeriodicWave(customWaves.synth_saw);
                }
                 else {
                    oscillator.type = currentWaveType; // Fallback to basic types
                }
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                individualGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                // Apply a slightly different envelope for pianish to simulate faster decay
                if (currentWaveType === "pianish") {
                    individualGainNode.gain.linearRampToValueAtTime(0.6, audioContext.currentTime + 0.01); // Quick attack
                    // For pianish, a faster release than other sounds might be good.
                    // This is a very simple decay, a real piano is more complex.
                    // gainNode.gain.setTargetAtTime(0, audioContext.currentTime + 0.02, 0.1); // Faster decay after attack
                } else {
                    individualGainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.02);
                }

                oscillator.connect(individualGainNode);
                individualGainNode.connect(masterGainNode);
                oscillator.start();
                activeOscillators[uniqueId] = { oscillator, individualGainNode, step };
            }

            function stopNote(step) { /* ... same ... */ }
            function stopNote(step) {
                const uniqueId = `${config.pianoId}-${currentTuningSystem}-${step}-${currentOctaveOffset}`;
                if (audioContext && activeOscillators[uniqueId]) {
                    const { oscillator, individualGainNode } = activeOscillators[uniqueId];
                    // Modify release based on wave type if desired
                    let releaseTime = 0.15;
                    if (currentWaveType === "pianish" || currentWaveType === "bright_pluck") {
                        releaseTime = 0.08; // Faster release for percussive sounds
                    }

                    individualGainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    individualGainNode.gain.setValueAtTime(individualGainNode.gain.value, audioContext.currentTime);
                    individualGainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + releaseTime);
                    oscillator.stop(audioContext.currentTime + releaseTime);
                    delete activeOscillators[uniqueId];
                }
            }


            function addKeyListeners(key) { /* ... same ... */ }
            function addKeyListeners(key) {
                const step = parseInt(key.dataset.step);
                const startInteraction = (e) => { e.preventDefault(); playNote(step); key.classList.add('active'); };
                const endInteraction = () => { stopNote(step); key.classList.remove('active'); };
                key.addEventListener('mousedown', startInteraction);
                key.addEventListener('touchstart', startInteraction, { passive: false });
                key.addEventListener('mouseup', endInteraction);
                key.addEventListener('touchend', endInteraction);
                key.addEventListener('touchcancel', endInteraction);
                key.addEventListener('mouseleave', () => { if (key.classList.contains('active')) endInteraction(); });
            }
            
            function stopAllNotesForThisInstance() { /* ... same ... */ }
            function stopAllNotesForThisInstance() {
                 if (!audioContext) return;
                 pianoElement.querySelectorAll('.key.active').forEach(k => k.classList.remove('active'));
                 for (const id in activeOscillators) {
                    const { oscillator, individualGainNode } = activeOscillators[id];
                    individualGainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    individualGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime);
                    delete activeOscillators[id];
                }
            }


            tuningSelectElement.addEventListener('change', updateTuningSystem);
            octaveUpButtonElement.addEventListener('click', () => { currentOctaveOffset++; updateOctaveDisplay(); });
            octaveDownButtonElement.addEventListener('click', () => { currentOctaveOffset--; updateOctaveDisplay(); });
            zoomSliderElement.addEventListener('input', applyZoom);
            volumeSliderElement.addEventListener('input', updateVolume);
            waveTypeSelectElement.addEventListener('change', updateWaveType);

            updateTuningDisplayTitle();
            generateKeys();
            updateOctaveDisplay();
            
            return { stopAllNotes: stopAllNotesForThisInstance };
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAudioContext();
            const defaultInitialOctave = 0;

            pianoInstances.push(createPianoInstance({ /* Piano 1 Config */
                pianoId: 'piano-keys-1',
                tuningDisplayId: 'tuning-display-1',
                tuningSelectId: 'tuning-select-1',
                octaveDisplayId: 'current-octave-1',
                octaveUpId: 'octave-up-1',
                octaveDownId: 'octave-down-1',
                zoomSliderId: 'zoom-slider-1',
                volumeSliderId: 'volume-slider-1',
                waveTypeId: 'wave-type-1',
                initialOctave: defaultInitialOctave
            }));

            pianoInstances.push(createPianoInstance({ /* Piano 2 Config */
                pianoId: 'piano-keys-2',
                tuningDisplayId: 'tuning-display-2',
                tuningSelectId: 'tuning-select-2',
                octaveDisplayId: 'current-octave-2',
                octaveUpId: 'octave-up-2',
                octaveDownId: 'octave-down-2',
                zoomSliderId: 'zoom-slider-2',
                volumeSliderId: 'volume-slider-2',
                waveTypeId: 'wave-type-2',
                initialOctave: defaultInitialOctave
            }));

            document.addEventListener('visibilitychange', () => { /* ... */ });
             document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    pianoInstances.forEach(instance => instance.stopAllNotes());
                }
            });
        });
    </script>
</body>
</html>